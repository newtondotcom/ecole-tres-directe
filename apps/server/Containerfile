# ===== Build Stage =====
FROM oven/bun AS builder
WORKDIR /usr/src/app

# Copy monorepo manifests to enable workspace install
COPY package.json bun.lock turbo.json ./
COPY apps/server/package.json apps/server/package.json
COPY packages/api/package.json packages/api/package.json
COPY packages/config/package.json packages/config/package.json

# Install all workspace deps
RUN bun install

# Copy full repo (needed for build)
COPY . .

# Build internal packages (generate dist/types)
RUN bun run --cwd packages/api build

# Compile server for target platform
RUN bun compile:server && ls -la apps/server/server

# ===== Runtime Stage =====
FROM debian:12-slim AS runtime

# Create non-root user
RUN useradd -r -u 989 -s /bin/false appuser

WORKDIR /app

# Copy compiled binary from builder
COPY --from=builder /usr/src/app/apps/server/server ./server

# Ensure permissions
RUN chown appuser:appuser ./server && chmod +x ./server

RUN mkdir -p logs && chown -R appuser:appuser /app

USER appuser

ENV NODE_ENV=production

EXPOSE 3001
ENTRYPOINT ["./server"]